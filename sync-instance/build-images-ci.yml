.job_template: &build_image_definition
  image: docker:19
  stage: build-image
  services:
    - alias: docker
      name: docker:19.03.5-dind
  script:
    - apk add --no-cache bash
    - bash ./ci_docker_build_push.sh

.only_var_template: &only_tag_release
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9.]+$/'

.template: &sync_image_definition
  variables: &sync_image_vars
    REGISTRY_USER: "${DH_CI_REGISTRY_USER}"
    REGISTRY_PASSWORD: "${DH_CI_REGISTRY_PASSWORD}"
    REGISTRY: "${DH_CI_REGISTRY}"
    DOCKER_FILE: "sync-instance/Dockerfile"
    DOCKER_NAME: "postgresai/sync-instance"

build-sync-postgres-9-6-image-latest:
  <<: *build_image_definition
  <<: *only_tag_release
  <<: *sync_image_definition
  variables:
    PG_SERVER_VERSION: "9.6"
    <<: *sync_image_vars
    TAGS: "${DOCKER_NAME}:${PG_SERVER_VERSION},${DOCKER_NAME}:${PG_SERVER_VERSION}-${CI_COMMIT_TAG}"

build-sync-postgres-10-image-latest:
  <<: *build_image_definition
  <<: *only_tag_release
  <<: *sync_image_definition
  variables:
    PG_SERVER_VERSION: "10"
    <<: *sync_image_vars
    TAGS: "${DOCKER_NAME}:${PG_SERVER_VERSION},${DOCKER_NAME}:${PG_SERVER_VERSION}-${CI_COMMIT_TAG}"

build-sync-postgres-11-image-latest:
  <<: *build_image_definition
  <<: *only_tag_release
  <<: *sync_image_definition
  variables:
    PG_SERVER_VERSION: "11"
    <<: *sync_image_vars
    TAGS: "${DOCKER_NAME}:${PG_SERVER_VERSION},${DOCKER_NAME}:${PG_SERVER_VERSION}-${CI_COMMIT_TAG}"

build-sync-postgres-12-image-latest:
  <<: *build_image_definition
  <<: *only_tag_release
  <<: *sync_image_definition
  variables:
    PG_SERVER_VERSION: "12"
    <<: *sync_image_vars
    TAGS: "${DOCKER_NAME}:${PG_SERVER_VERSION},${DOCKER_NAME}:${PG_SERVER_VERSION}-${CI_COMMIT_TAG}"
